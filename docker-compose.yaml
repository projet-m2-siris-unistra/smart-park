version: '3'

services:
  web:
    build: web
    ports:
    - "8080:8080"
    environment:
      NATS_URL: nats://nats:4222

  nats:
    image: nats-streaming
    ports:
    - "4222:4222"
    - "8222:8222"

  database:
    image: postgres
    environment:
      POSTGRES_DB: postgres
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
    - "5432:5432"

  migrations:
    image: migrate/migrate:v4.7.0
    command: -database=postgres://postgres:postgres@database/postgres?sslmode=disable -path=/migrations up
    depends_on:
    - database
    volumes:
    - "./backend/database/migrations:/migrations"

  backend:
    build: backend
    depends_on:
    - database
    - nats
    environment:
      NATS_URL: nats://nats:4222
      DATABASE: postgres://postgres:postgres@database/postgres?sslmode=disable
